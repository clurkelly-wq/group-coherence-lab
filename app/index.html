<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Quantum Consciousness Coherence App</title>
<meta name="theme-color" content="#88eeff"/>
<style>
:root{--bg:#0f1120;--panel:#16192b;--ink:#e8ecff;--muted:#93a0c7;--accent:#38bdf8;--ok:#34d399;--warn:#f59e0b;--strong:#10b981;--extra:#a78bfa;--normal:#64748b}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{padding:16px;text-align:center}
h1{margin:0;font-size:22px;letter-spacing:.4px}
.subtitle{color:#93a0c7;font-size:13px;margin-top:6px}
.wrap{max-width:980px;margin:0 auto;padding:8px 16px 40px}
.card{background:var(--panel);border:1px solid #262a43;border-radius:14px;padding:16px}
.label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px}
input,select{background:#0e1020;border:1px solid #2b3158;color:var(--ink);border-radius:10px;padding:10px 12px;width:100%;box-sizing:border-box}
.row3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;align-items:end}
.row2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;align-items:center}
@media(max-width:820px){.row3{grid-template-columns:1fr;gap:10px}.row2{grid-template-columns:1fr;gap:10px}}
button{background:linear-gradient(180deg,#38bdf8,#0ea5e9);border:none;color:#00111a;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer}
button.ghost{background:#1f2547;color:#e8ecff;border:1px solid #2b3158}
button:disabled{opacity:.65;cursor:not-allowed}
.btn-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn-large{padding:14px 22px;font-size:15px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #2b3158;border-radius:999px;color:#e8ecff;font-size:12px;background:#1a2044;white-space:nowrap}
.pill.spinner::before{content:"";width:10px;height:10px;border-radius:999px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;display:inline-block;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.info-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.effect{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;font-weight:700}
.effect.normal{background:#0f172a;color:#cbd5e1;border:1px solid #334155}
.effect.possible{background:#1f2937;color:#fde68a;border:1px solid #6b7280}
.effect.strong{background:#042f2e;color:#a7f3d0;border:1px solid #065f46}
.effect.extra{background:#1e1b4b;color:#ddd6fe;border:1px solid #4c1d95}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px;white-space:nowrap}
.badge.normal{background:#111827;color:#cbd5e1;border:1px solid #374151}
.badge.possible{background:#1f2937;color:#fde68a;border:1px solid #6b7280}
.badge.strong{background:#064e3b;color:#a7f3d0;border:1px solid #065f46}
.badge.extra{background:#312e81;color:#ddd6fe;border:1px solid #4c1d95}
.tablewrap{max-width:100%;overflow:auto;border:1px solid #262a43;border-radius:12px}
table{width:100%;border-collapse:collapse;min-width:820px}th,td{padding:8px 10px;border-bottom:1px solid #262a43;text-align:left}
canvas{width:100%;height:260px;background:#0b0d1a;border:1px solid #22264a;border-radius:10px;display:block}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.stat{background:#0e1020;border:1px solid #22264a;border-radius:10px;padding:10px}
.stat b{display:block;font-size:20px;margin-top:6px;color:#bfe6ff}
.danger{background:linear-gradient(180deg,#fca5a5,#ef4444);color:#190404;border:none}
.top-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
.helper-bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:10px 0 4px}
.help-btn{background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#00111a;border:none;border-radius:999px;padding:10px 16px;font-weight:800}
.spacer{height:6px}
.error{color:#ffbaba;background:#3b0f0f;border:1px solid #6b1d1d;padding:8px;border-radius:10px;margin-top:10px;display:none}
.hidden{display:none!important}
</style>
<script>(function(){const p=new URLSearchParams(location.search);const project=(p.get('project')||'').trim()||'clares-data';window.__GCLAB__={version:'v10.6.1',project};})();</script>
</head>
<body>
<header>
  <h1>Quantum Consciousness Coherence App</h1>
  <div class="subtitle">Testing how our consciousness affects a quantum random number generator, by Clare Kelly</div>
</header>
<div class="wrap">
  <div class="helper-bar">
    <div style="flex:1"></div>
    <button id="helpBtn" class="help-btn">What even is this?</button>
  </div>
  <div id="errPanel" class="error"></div>
  <div class="card" style="margin-top:8px">
    <div class="label">Session setup</div>
    <div class="row3" style="margin-top:10px">
      <div><div class="label">Tester name</div><input id="testerName" placeholder="e.g., Clare"/></div>
      <div><div class="label">Session title</div><input id="sessionTitle" placeholder="e.g., Sunday Circle"/></div>
      <div><div class="label">Duration (minutes)</div><input id="duration" type="number" min="1" max="180" value="20"/></div>
    </div>
    <div class="row3" style="margin-top:10px">
      <div><div class="label">Trial size (bits)</div><input id="trialBits" type="number" min="50" max="4000" value="200"/></div>
      <div><div class="label">Alpha</div><select id="alpha"><option value="0.05" selected>0.05 (95%)</option><option value="0.01">0.01 (99%)</option></select></div>
      <div><div class="label">Auto‑mark unusual moments</div>
        <select id="autoMark">
          <option value="possible" selected>Effect ≥ Possible</option>
          <option value="strong">Effect ≥ Strong</option>
          <option value="extra">Effect ≥ Extraordinary</option>
        </select>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="btn-row" style="margin-top:6px">
      <button id="startBtn" class="btn-large">Start</button>
      <button id="stopBtn" class="btn-large" disabled>End</button>
      <button id="markBtn" class="ghost" disabled>Mark moment</button>
    </div>
    <div class="info-row">
      <span class="pill" id="elapsed">Elapsed: 00:00</span>
      <span class="pill hidden" id="offlinePill">Offline mode — logging locally</span>
      <span class="pill spinner hidden" id="syncPill">Syncing…</span>
    </div>
    <div style="margin-top:10px"><span id="liveEffect" class="effect normal">No unusual pattern detected — randomness looks normal.</span></div>
  </div>
  <div class="grid" style="display:grid;grid-template-columns:1.2fr 1fr;gap:16px;margin-top:16px">
    <div class="card">
      <div class="label">Live deviation</div>
      <canvas id="plot" width="800" height="260"></canvas>
      <div class="stats">
        <div class="stat"><span class="small muted">Overall Drift</span><b id="cumZ">—</b></div>
        <div class="stat"><span class="small muted">How Unusual?</span><b id="pval">—</b></div>
        <div class="stat"><span class="small muted">Number of Tests</span><b id="trials">0</b></div>
      </div>
    </div>
    <div class="card">
      <div class="label">Past sessions (shared)</div>
      <div class="top-actions">
        <button id="exportCsv">Export CSV</button>
        <button id="exportPdf">Export PDF</button>
        <button id="deleteAll" class="danger">Delete All Data</button>
      </div>
      <div class="tablewrap" style="margin-top:10px">
        <table id="resultsTable"><thead><tr>
          <th>#</th><th>Tester</th><th>Title</th><th>Start</th><th>Min</th><th>Tests</th><th>Bits/Trial</th><th>Alpha</th><th>Z</th><th>p</th><th>Effect</th>
        </tr></thead><tbody id="resultsBody"></tbody></table>
      </div>
    </div>
  </div>
  <div class="card" id="finalCard" style="display:none;margin-top:16px">
    <div id="finalEffect" class="effect normal">Session complete — randomness looked normal overall.</div>
  </div>
</div>
<div class="overlay" id="helpOverlay" role="dialog" aria-modal="true" aria-labelledby="helpTitle" style="position:fixed;inset:0;background:rgba(0,0,20,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:16px;z-index:50">
  <div class="modal" style="background:#0f1328;border:1px solid #2b3158;border-radius:16px;max-width:860px;width:100%;max-height:85vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <header style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #24304f">
      <h2 id="helpTitle" style="margin:0;font-size:18px">Help & How it Works</h2>
      <button id="closeHelp" class="ghost">Close</button>
    </header>
    <div class="content" style="padding:16px">
      <p><b>Quantum Consciousness Coherence App</b> explores whether shared intention affects a quantum random number generator (QRNG). You set a duration and focus together; the app measures drift from randomness.</p>
      <p style="color:#93a0c7">Two knobs you can adjust:</p>
      <ul>
        <li><b>Alpha</b>: how strict the test is. 0.05 is standard (easier to see effects); 0.01 is stricter (harder to trigger but fewer “false alarms”).</li>
        <li><b>Trial size</b>: how many bits per test. Small = faster, but noisier. Large = slower, but steadier.</li>
      </ul>
      <hr style="border-color:#24304f;border-style:solid;border-width:1px 0 0;margin:12px 0"/>
      <p><b>Color legend (based on cumulative z‑score)</b></p>
      <div class="legend" style="display:grid;gap:8px;margin:8px 0 16px">
        <div class="row" style="display:flex;align-items:center;gap:10px"><span style="width:16px;height:16px;border-radius:4px;background:#111827;border:1px solid #2b3158"></span> <b>Grey — No unusual pattern</b> <span style="color:#93a0c7">| |z| &lt; 1.96</span></div>
        <div class="row" style="display:flex;align-items:center;gap:10px"><span style="width:16px;height:16px;border-radius:4px;background:#1f2937;border:1px solid #2b3158"></span> <b>Yellow — Possible group influence</b> <span style="color:#93a0c7">| 1.96 ≤ |z| &lt; 2.58</span></div>
        <div class="row" style="display:flex;align-items:center;gap:10px"><span style="width:16px;height:16px;border-radius:4px;background:#064e3b;border:1px solid #2b3158"></span> <b>Green — Strong effect</b> <span style="color:#93a0c7">| 2.58 ≤ |z| &lt; 3.29</span></div>
        <div class="row" style="display:flex;align-items:center;gap:10px"><span style="width:16px;height:16px;border-radius:4px;background:#312e81;border:1px solid #2b3158"></span> <b>Purple — Extraordinary coherence</b> <span style="color:#93a0c7">| |z| ≥ 3.29</span></div>
      </div>
      <p style="color:#93a0c7">Tip: Larger groups or deeper coherence often show smoother, stronger drift.</p>
      <hr style="border-color:#24304f;border-style:solid;border-width:1px 0 0;margin:12px 0"/>
      <p><b>Watch: Quick intro</b></p>
      <div class="ytwrap" style="position:relative;padding-top:56.25%;border-radius:12px;overflow:hidden;border:1px solid #24304f;background:#000">
        <iframe src="https://www.youtube.com/embed/Sp7-6850Mls" title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen style="position:absolute;inset:0;width:100%;height:100%"></iframe>
      </div>
    </div>
  </div>
</div>
<script>
function qs(id){return document.getElementById(id)}
function showErr(m){const e=qs('errPanel');e.textContent=m||'';e.style.display=m?'block':'none'}
const SUPABASE_URL="https://wyecvewtlgyzizupocfh.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5ZWN2ZXd0bGd5eml6dXBvY2ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMTYzODcsImV4cCI6MjA3MDY5MjM4N30.nfcrwzm1t-d5l3DiME5RFahC_LVxStn0IekaPjMKMpg";
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
const SB=supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
const PROJECT=(window.__GCLAB__&&window.__GCLAB__.project)||'clares-data';
if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(()=>{})})}
function setOffline(on){qs('offlinePill').classList.toggle('hidden',!on)}
function setSyncing(on){qs('syncPill').classList.toggle('hidden',!on)}
window.addEventListener('online',()=>{setOffline(false);flushOutbox()});
window.addEventListener('offline',()=>{setOffline(true)});
function erf(x){const s=x>=0?1:-1;x=Math.abs(x);const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;const t=1/(1+p*x);const y=1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);return s*y}
function cdfNormal(z){return .5*(1+erf(z/Math.SQRT2))}
function twoSidedP(z){return 2*(1-cdfNormal(Math.abs(z)))}
function stoufferZ(zs){if(!zs.length)return 0;const s=zs.reduce((a,b)=>a+b,0);return s/Math.sqrt(zs.length)}
function effectLabel(p,alpha){const a=parseFloat(alpha||'0.05');if(!isFinite(p))return{cls:'normal',text:'No unusual pattern detected — randomness looks normal.',tier:'Normal'};if(p<=0.2*a||p<=0.001)return{cls:'extra',text:'Extraordinary effect — high coherence observed!',tier:'Extraordinary'};if(p<=0.5*a||p<=0.01)return{cls:'strong',text:'Strong effect detected — group focus seems to influence the RNG.',tier:'Strong'};if(p<=a)return{cls:'possible',text:'Small shift detected — possible group influence.',tier:'Possible'};return{cls:'normal',text:'No unusual pattern detected — randomness looks normal.',tier:'Normal'}}
function badgeHtml(tier){const cls=(tier||'Normal').toLowerCase();return `<span class="badge ${cls}">${tier}</span>`}
function setLiveEffect(p,alpha){const info=effectLabel(p,alpha);const el=qs('liveEffect');el.className='effect '+info.cls;el.textContent=info.text;return info.tier}
function setFinalEffect(p,alpha){const info=effectLabel(p,alpha);const el=qs('finalEffect');el.className='effect '+info.cls;el.textContent='Session complete — '+info.text.replace(/^No unusual pattern detected — /,'').trim();qs('finalCard').style.display='block';return info.tier}
const canvas=document.getElementById('plot');const ctx=canvas.getContext('2d');
function clearPlot(){ctx.fillStyle='#0b0d1a';ctx.fillRect(0,0,canvas.width,canvas.height)}
function drawAxes(){ctx.strokeStyle='#22264a';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(40,10);ctx.lineTo(40,canvas.height-20);ctx.lineTo(canvas.width-10,canvas.height-20);ctx.stroke();ctx.fillStyle='#93a0c7';ctx.font='12px system-ui';ctx.fillText('Z',10,16);ctx.fillText('Trials →',canvas.width-100,canvas.height-6)}
function plotSeries(zs,alpha){clearPlot();drawAxes();const w=canvas.width-50,h=canvas.height-40,x0=40,y0=canvas.height-20;const n=Math.max(1,zs.length);let cums=[],s=0;for(let i=0;i<n;i++){s+=zs[i];cums.push(s/Math.sqrt(i+1))}const zStar=(alpha==='0.01')?2.576:1.96;const ymax=Math.max(zStar*1.3,Math.max(...cums.map(v=>Math.abs(v)))+0.5);function x(i){return x0+(w*(i/(n-1||1)))}function y(v){return y0-(v/ymax)*(h/2)}ctx.strokeStyle='#2b3158';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(x0,y(zStar));ctx.lineTo(x0+w,y(zStar));ctx.stroke();ctx.beginPath();ctx.moveTo(x0,y(-zStar));ctx.lineTo(x0+w,y(-zStar));ctx.stroke();ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#88eeff';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(x(0),y(cums[0]||0));for(let i=1;i<n;i++){ctx.lineTo(x(i),y(cums[i]))}ctx.stroke()}
function cacheGet(){try{return JSON.parse(localStorage.getItem('sessions_cache')||'[]')}catch(_){return []}}
function cacheSet(arr){localStorage.setItem('sessions_cache',JSON.stringify(arr||[]))}
function outboxGet(){try{return JSON.parse(localStorage.getItem('sessions_outbox')||'[]')}catch(_){return []}}
function outboxSet(arr){localStorage.setItem('sessions_outbox',JSON.stringify(arr||[]))}
async function dbFetch(project){try{const {data,error}=await SB.from('sessions').select('*').eq('project',project).order('start',{ascending:false}).limit(500);if(error)throw error;const cached=cacheGet().filter(r=>r.project!==project);cacheSet([...(data||[]),...cached]);return data||[]}catch(e){const cached=cacheGet().filter(r=>r.project===project);return cached}}
async function dbInsert(project,rec){try{const {error}=await SB.from('sessions').insert(rec);if(error)throw error}catch(e){const out=outboxGet();out.push(rec);outboxSet(out);const cache=cacheGet();cache.unshift(rec);cacheSet(cache);setOffline(true)}}
async function dbDeleteAll(project){try{const {error}=await SB.from('sessions').delete().eq('project',project);if(error)throw error}catch(e){const keep=cacheGet().filter(r=>r.project!==project);cacheSet(keep);const out=outboxGet().filter(r=>r.project!==project);outboxSet(out);throw e}}
async function flushOutbox(){const out=outboxGet();if(!out.length)return;setSyncing(true);try{const batchSize=50;for(let i=0;i<out.length;i+=batchSize){const slice=out.slice(i,i+batchSize);const {error}=await SB.from('sessions').insert(slice);if(error)throw error}outboxSet([]);setOffline(false);await refreshTable()}catch(e){}finally{setSyncing(false)}}
function renderTable(rows){const body=qs('resultsBody');body.innerHTML=rows.map((r,i)=>{const tier=r.effect_label||'';return `<tr>
<td>${i+1}</td><td>${r.tester||''}</td><td>${r.title||''}</td>
<td>${new Date(r.start).toLocaleString()}</td><td>${r.duration_min}</td>
<td>${r.trials}</td><td>${r.trial_bits}</td><td>${r.alpha}</td>
<td>${(+r.z).toFixed(3)}</td><td>${(+r.p).toExponential(2)}</td>
<td>${tier?badgeHtml(tier):''}</td></tr>`}).join('')}
qs('exportCsv').addEventListener('click',async()=>{const s=await dbFetch(PROJECT);const header=['project','tester','title','start','duration_min','trials','trial_bits','alpha','z','p','effect_label'];const lines=[header.join(',')].concat(s.map(r=>header.map(k=>r[k]).join(',')));const blob=new Blob([lines.join('
')],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`gclab_sessions_${PROJECT}.csv`;a.click();URL.revokeObjectURL(url)})
qs('exportPdf').addEventListener('click',async()=>{const s=await dbFetch(PROJECT);const {jsPDF}=window.jspdf;const doc=new jsPDF({unit:'pt',format:'a4'});doc.setFont('helvetica','bold');doc.setFontSize(16);doc.text('Group Coherence — All Sessions',40,40);doc.setFont('helvetica','normal');doc.setFontSize(10);doc.text('Project: '+PROJECT,40,58);const head=[['#','Tester','Title','Start','Min','Tests','Bits','Alpha','Z','p','Effect']];const body=s.map((r,i)=>[i+1,r.tester||'',r.title||'',new Date(r.start).toLocaleString(),r.duration_min,r.trials,r.trial_bits,r.alpha,(+r.z).toFixed(3),(+r.p).toExponential(2),r.effect_label||'']);doc.autoTable({head,body,startY:72,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[14,165,233]}});doc.save(`group_coherence_sessions_${PROJECT}.pdf`)})
qs('deleteAll').addEventListener('click',async()=>{const ok=confirm(`Delete ALL data for project "${PROJECT}"? This cannot be undone.`);if(!ok)return;try{await dbDeleteAll(PROJECT)}catch(e){}await refreshTable()})
async function qrng(len){try{const r=await fetch(`/.netlify/functions/qrng?len=${len}`,{mode:'cors'});if(!r.ok)throw new Error('qrng failed');const j=await r.json();const arr=j.data||[];return new Uint16Array(arr.map(x=>x&0xFFFF))}catch(e){const out=new Uint16Array(Math.max(1,len));(crypto||window.crypto).getRandomValues(out);return out}}
let session=null,elapsedTimer=null;const nameEl=qs('testerName'),titleEl=qs('sessionTitle'),durEl=qs('duration'),trialBitsEl=qs('trialBits'),alphaEl=qs('alpha'),autoMarkEl=qs('autoMark');const startBtn=qs('startBtn'),stopBtn=qs('stopBtn'),markBtn=qs('markBtn'),elapsedEl=qs('elapsed');
function lockUI(run){[nameEl,titleEl,durEl,trialBitsEl,alphaEl,autoMarkEl,startBtn].forEach(el=>el.disabled=run);stopBtn.disabled=!run;markBtn.disabled=!run}
function startElapsed(){const t0=Date.now();elapsedEl.textContent='Elapsed: 00:00';if(elapsedTimer)clearInterval(elapsedTimer);elapsedTimer=setInterval(()=>{const ms=Date.now()-t0;const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000);elapsedEl.textContent=`Elapsed: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`},500)}
function stopElapsed(){if(elapsedTimer){clearInterval(elapsedTimer);elapsedTimer=null}}
function meetsThreshold(tier,threshold){const order={'Normal':0,'Possible':1,'Strong':2,'Extraordinary':3};const t={'possible':1,'strong':2,'extra':3}[threshold]??1;return (order[tier]||0)>=t}
async function markMoment(cumZ,p,tier,plan,trialsSoFar){const rec={project:PROJECT,tester:plan.tester,title:(plan.title||'')+' • Moment',start:new Date().toISOString(),duration_min:0,trials:trialsSoFar,trial_bits:plan.trial_bits,alpha:plan.alpha,z:cumZ,p:p,effect_label:tier};await dbInsert(PROJECT,rec)}
async function runSession(){const plan={tester:nameEl.value.trim()||'—',title:titleEl.value.trim(),duration_min:Math.max(1,parseInt(durEl.value||'20',10)),trial_bits:Math.max(50,parseInt(trialBitsEl.value||'200',10)),alpha:alphaEl.value,start:new Date().toISOString()};session={plan,zs:[],stop:false};lockUI(true);clearPlot();drawAxes();startElapsed();setOffline(!navigator.onLine);const endTime=Date.now()+plan.duration_min*60*1000;try{while(!session.stop&&Date.now()<endTime){const words=Math.ceil(plan.trial_bits/16);const u16=await qrng(Math.min(2048,words));const bits=[];for(let i=0;i<u16.length;i++){let v=u16[i];for(let b=0;b<16;b++){bits.push((v>>b)&1)}}const trial=bits.slice(0,plan.trial_bits);const sum=trial.reduce((a,b)=>a+b,0);const n=plan.trial_bits,mu=n/2,sigma=Math.sqrt(n/4);const z=(sum-mu)/sigma;session.zs.push(z);qs('trials').textContent=session.zs.length;const cumZ=session.zs.reduce((a,b)=>a+b,0)/Math.sqrt(session.zs.length);const p=twoSidedP(cumZ);qs('cumZ').textContent=cumZ.toFixed(3);qs('pval').textContent=p.toExponential(2);const tier=setLiveEffect(p,plan.alpha);plotSeries(session.zs,plan.alpha);if(meetsThreshold(tier,autoMarkEl.value)){await markMoment(cumZ,p,tier,plan,session.zs.length)}await new Promise(r=>setTimeout(r,1000))}const cumZ=session.zs.reduce((a,b)=>a+b,0)/Math.sqrt(Math.max(1,session.zs.length));const p=twoSidedP(cumZ);const tier=setFinalEffect(p,plan.alpha);const rec={project:PROJECT,tester:plan.tester,title:plan.title,start:plan.start,duration_min:plan.duration_min,trials:session.zs.length,trial_bits:plan.trial_bits,alpha:plan.alpha,z:cumZ,p:p,effect_label:tier};await dbInsert(PROJECT,rec);const rows=await dbFetch(PROJECT);renderTable(rows)}catch(e){showErr(e.message||String(e))}finally{stopElapsed();lockUI(false);session=null;flushOutbox()}}
qs('helpBtn').addEventListener('click',()=>qs('helpOverlay').style.display='flex')
qs('closeHelp').addEventListener('click',()=>qs('helpOverlay').style.display='none')
qs('helpOverlay').addEventListener('click',(e)=>{if(e.target===qs('helpOverlay'))qs('helpOverlay').style.display='none'})
qs('startBtn').addEventListener('click',()=>{if(session)return;runSession()})
qs('stopBtn').addEventListener('click',()=>{if(session)session.stop=true})
qs('markBtn').addEventListener('click',async()=>{if(!session)return;const zs=session.zs;const cumZ=zs.reduce((a,b)=>a+b,0)/Math.sqrt(Math.max(1,zs.length));const p=twoSidedP(cumZ);const tier=effectLabel(p,session.plan.alpha).tier;await markMoment(cumZ,p,tier,session.plan,zs.length);const rows=await dbFetch(PROJECT);renderTable(rows)})
async function refreshTable(){const rows=await dbFetch(PROJECT);renderTable(rows)}
(async function boot(){clearPlot();drawAxes();setOffline(!navigator.onLine);await refreshTable();await flushOutbox()})();
</script>
</body>
</html>
